<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Build, deploy and run an application with ECR, ECS and Codebuild (Part 1) | Time-to-Geek</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Introduction In this article, we will follow the complete development cycle of a real-world application from its conception to its production. Nowadays, the wind of the moment pushes us all to turn to the cloud because in many aspects it offers more advantages compared to on-premises systems.
I decided to divide this tutorial into two parts given its volume, so for this first part, we will focus in more detail on the infrastructure to be deployed and the motivation behind the choice of technologies used."><meta name=generator content="Hugo 0.108.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.98b8feee71ad3d56ea881041d877c631e7268369636aa10acbcb1c7f3bd3ea41.css><meta property="og:title" content="Build, deploy and run an application with ECR, ECS and Codebuild (Part 1)"><meta property="og:description" content="Introduction In this article, we will follow the complete development cycle of a real-world application from its conception to its production. Nowadays, the wind of the moment pushes us all to turn to the cloud because in many aspects it offers more advantages compared to on-premises systems.
I decided to divide this tutorial into two parts given its volume, so for this first part, we will focus in more detail on the infrastructure to be deployed and the motivation behind the choice of technologies used."><meta property="og:type" content="article"><meta property="og:url" content="https://yvesdenis.github.io/post/ecs-ecr-codebuild-part-1-post/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-11T11:20:08-04:00"><meta property="article:modified_time" content="2022-12-11T11:20:08-04:00"><meta property="og:site_name" content="Time-to-Geek"><meta itemprop=name content="Build, deploy and run an application with ECR, ECS and Codebuild (Part 1)"><meta itemprop=description content="Introduction In this article, we will follow the complete development cycle of a real-world application from its conception to its production. Nowadays, the wind of the moment pushes us all to turn to the cloud because in many aspects it offers more advantages compared to on-premises systems.
I decided to divide this tutorial into two parts given its volume, so for this first part, we will focus in more detail on the infrastructure to be deployed and the motivation behind the choice of technologies used."><meta itemprop=datePublished content="2022-12-11T11:20:08-04:00"><meta itemprop=dateModified content="2022-12-11T11:20:08-04:00"><meta itemprop=wordCount content="823"><meta itemprop=keywords content="Aws,IAC,DevOps,Cloud,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Build, deploy and run an application with ECR, ECS and Codebuild (Part 1)"><meta name=twitter:description content="Introduction In this article, we will follow the complete development cycle of a real-world application from its conception to its production. Nowadays, the wind of the moment pushes us all to turn to the cloud because in many aspects it offers more advantages compared to on-premises systems.
I decided to divide this tutorial into two parts given its volume, so for this first part, we will focus in more detail on the infrastructure to be deployed and the motivation behind the choice of technologies used."></head><body class="ma0 avenir bg-near-white production"><header class="cover bg-top" style=background-image:url(https://yvesdenis.github.io/images/aws_terraform.png)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Time-to-Geek</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/post/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/contact/ title="Contact page">Contact</a></li></ul><div class=ananke-socials><a href=https://github.com/yvesDenis target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHubâ€”â€”Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><div class="f2 f1-l fw2 white-90 mb0 lh-title">Build, deploy and run an application with ECR, ECS and Codebuild (Part 1)</div></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">ARTICLES</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Build, deploy and run an application with ECR, ECS and Codebuild (Part 1)</h1><p class=tracked>By <strong>Yves Denis Deffo</strong></p><time class="f6 mv4 dib tracked" datetime=2022-12-11T11:20:08-04:00>December 11, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id=introduction>Introduction</h2><p>In this article, we will follow the complete development cycle of a real-world application from its conception to its production.
Nowadays, the wind of the moment pushes us all to turn to the cloud because in many aspects it offers more advantages compared to on-premises systems.</p><p>I decided to divide this tutorial into two parts given its volume, so for this first part, we will focus in more detail on the infrastructure to be deployed and the motivation behind the choice of technologies used.</p><p>The source code of this first part : <a href=https://github.com/yvesDenis/website-projects-articles/tree/complete-task/deploy-app-aws-ecs/iac>https://github.com/yvesDenis/website-projects-articles/tree/complete-task/deploy-app-aws-ecs/iac</a></p><h2 id=architecture-diagram>Architecture diagram</h2><p><img src=/images/ecs-ecr/codebuild-ecr-ecs-project.svg alt="build and deploy IAC for ecs,codebuild and ecr"></p><p>We opted for a scenario as close as possible to a real production situation. To do this, our technology platform includes a continuous integration and deployment chain using Github actions, which also serves as our VCS.
The deployment of the cloud infrastructure will be done using Terragrunt.</p><p><em>Hold on Mister! What is Terragrunt and why the hell are you using it?</em> ðŸ˜°</p><h3 id=terragrunt>Terragrunt</h3><p><a href=https://terragrunt.gruntwork.io/>Terragrunt</a> is a thin wrapper that provides extra tools for keeping your configurations DRY, working with multiple Terraform modules, and managing remote state. It helps avoiding
configuration duplication and for our use-case ,its <a href=https://terragrunt.gruntwork.io/docs/features/execute-terraform-commands-on-multiple-modules-at-once/>run-all command</a> is useful for us as we don&rsquo;t want to write large script files to deploy each terraform module.</p><p>There are several ways to manage the state of modules with terraform. The most common is the one with S3 and DynamoDb for locking but Hashicorp, for some time, has been deploying a <a href=https://app.terraform.io/>free Saas Terraform cloud solution</a> which allows you to execute Terraform commands directly in an online console and to preserve the state of the modules. This is the main reason why we chose Terraform Cloud because it integrates so well with Terragrunt.</p><h3 id=aws-codebuild>AWS Codebuild</h3><p>Our app needs to be tested on every push. For testing, <a href=https://aws.amazon.com/codebuild/>Codebuild</a> seems really suitable because it has a natural integration with external providers such as Github , Gitlab, bitbucket , etc&mldr; and it is agentless and serverless , so no need to manage the servers below and we pay for what we use with the principle of pay-as-you-go. It is mainly used for builds but since the application will be built directly in the docker image, it is not necessary to build it again in Codebuild.</p><script type=application/javascript src=https://gist.github.com/yvesDenis/5dfe68816b926ae392a62920a498b5d9.js></script><p>The webhook above is necessary cause we want Codebuild to execute tests every time a change is pushed to our repository.</p><h3 id=aws-ecr>AWS ECR</h3><p>Apps that run in containers need a Docker image deployed in a public or private remote repository. In our case, our choice fell on the <a href=https://aws.amazon.com/it/ecr/>Elastic Container repository (ECR)</a> cloud solution which allows us to host the Docker image of our <a href=https://github.com/yvesDenis/website-projects-articles/tree/complete-task/deploy-app-aws-ecs/base-app>mini app written in Golang</a>.</p><script type=application/javascript src=https://gist.github.com/yvesDenis/39d3f62049569265e497ae5208cde67f.js></script><h3 id=aws-ecs>AWS ECS</h3><p><a href=https://aws.amazon.com/it/ecs/>ECS</a> is a container orchestration service. It is fully managed by AWS and is highly scalable and secure. For the moment it suffers from competition with its neighbor EKS which, in addition to being open-source through Kubernetes, is more complex but more used in business. However, when we take a closer look, we realize that ECS is easier to tame, especially for all those who have not used a containerization solution in the past. That&rsquo;s why i gave it a try ðŸ˜‰</p><script type=application/javascript src=https://gist.github.com/yvesDenis/2594dd4ec6e7ed1c0f29e2a2cc6cbfff.js></script><p>We chose to use EC2 instances instead of Fargate. The created cluster comes with the following components:</p><ul><li><a href=https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html>ALB (Application load balancer)</a>: Internet faced to test the app via the Internet</li><li><a href=https://aws.amazon.com/it/autoscaling/>AutoScaling group</a>: To manage the automatic scaling of EC2 instances via the launch-template</li><li><a href=https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html>ALB Target-Groups</a>: To link the ALB and the autoscaling-group.</li><li><a href=https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html>ECS Service</a>: To run and maintain a specified number of instances of a task definition simultaneously in an Amazon ECS cluster.</li><li><a href=https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html>Task</a>: Instantiation of a task definition within a cluster.</li></ul><h3 id=compliance-tests-with-inspec>Compliance tests with Inspec</h3><p><a href=https://www.chef.io/blog/making-use-of-inspec-aws-cloud-resource>Chef InSpec</a> isâ€¯an open-source testing framework for infrastructure with human as well as machine-readable language for specifying compliance and security policy requirements. It helps us check that our cloud components are well deployed and work as expected. It&rsquo;s part of our continuous pipeline but operates at the end of the deployement to make sure anything is fine.
For thsi tutorial , we only test ECS components and ECR repository as so far there&rsquo;s no InSpec audit resource for Codebuild.</p><h2 id=continuous-deployment-pipeline-with-github-actions>Continuous deployment pipeline with Github actions</h2><p>Here&rsquo;s the job responsible to deploy our infrasctructure:</p><script type=application/javascript src=https://gist.github.com/yvesDenis/c2c180f611cdd0c19b23b22a3eca49df.js></script><p>To make Giyhub interact with AWS resources , you need to <a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services>configure OpenID Connect in Amazon Web Services</a></p><ol><li>Github source code checkout</li><li>Configure AWS credentials</li><li>Install terragrunt and terraform</li><li>Create a hidden file .terraformrc with <a href=https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens>Tfc token</a> to log into Terraform cloud</li><li>Terragrunt validate</li><li>Terragrunt plan</li><li>Terragrunt apply once for all terraform mdoules</li><li>Run compliance tests to ECS ans ECR resources.</li></ol><p>With this set-up , if you push you changes to an iac-prefix branch , your AWS resources will be deployed.</p><p><img src=/images/goal_giphy.gif alt="Goal celebration"></p><h2 id=summary>Summary</h2><p>In this first part we covered the ECS-ECR-Codebuild configuration deployment with compliance tests. For the second part we&rsquo;ll focus on the application testing through the browser and unit tests execution and results.</p><ul class=pa0><li class="list di"><a href=/tags/aws/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Aws</a></li><li class="list di"><a href=/tags/iac/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">IAC</a></li><li class="list di"><a href=/tags/devops/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">DevOps</a></li><li class="list di"><a href=/tags/cloud/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Cloud</a></li></ul><div class=addthis_inline_share_toolbox></div><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script"),n="https-yvesdenis-github-io";t.src="https://"+n+".disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">What's in this post</p><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#architecture-diagram>Architecture diagram</a><ul><li><a href=#terragrunt>Terragrunt</a></li><li><a href=#aws-codebuild>AWS Codebuild</a></li><li><a href=#aws-ecr>AWS ECR</a></li><li><a href=#aws-ecs>AWS ECS</a></li><li><a href=#compliance-tests-with-inspec>Compliance tests with Inspec</a></li></ul></li><li><a href=#continuous-deployment-pipeline-with-github-actions>Continuous deployment pipeline with Github actions</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://yvesdenis.github.io/>&copy; Time-to-Geek 2022</a><div><div class=ananke-socials><a href=https://github.com/yvesDenis target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHubâ€”â€”Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer><script id=dsq-count-scr src=//https-yvesdenis-github-io.disqus.com/count.js async></script>
<script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-6382ff1e2fa5e2f7"></script></body></html>