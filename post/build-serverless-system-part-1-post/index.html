<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Build serverless system with Pulumi and AWS (Part 1) | Time-to-Geek</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Introduction In my journey in the cloud and in the preparation of cloud certifications, I have been inspired by the AWS workshops carried out and generously made available to everyone by the AWS team.
This workshop which deals with the implementation of a serverless system is a must for all aspiring cloud engineers. It covers both the event-driven approach and the synchronous web-server mechanism.
In this post, we are working to resume the basic concept but bringing a DevOps concept with a pipeline to automate our deployments and also adding a front-end part also deployed in an automated way in the cloud."><meta name=generator content="Hugo 0.110.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.98b8feee71ad3d56ea881041d877c631e7268369636aa10acbcb1c7f3bd3ea41.css><meta property="og:title" content="Build serverless system with Pulumi and AWS (Part 1)"><meta property="og:description" content="Introduction In my journey in the cloud and in the preparation of cloud certifications, I have been inspired by the AWS workshops carried out and generously made available to everyone by the AWS team.
This workshop which deals with the implementation of a serverless system is a must for all aspiring cloud engineers. It covers both the event-driven approach and the synchronous web-server mechanism.
In this post, we are working to resume the basic concept but bringing a DevOps concept with a pipeline to automate our deployments and also adding a front-end part also deployed in an automated way in the cloud."><meta property="og:type" content="article"><meta property="og:url" content="https://yvesdenis.github.io/post/build-serverless-system-part-1-post/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-02T08:13:08-04:00"><meta property="article:modified_time" content="2023-01-21T16:43:50-05:00"><meta property="og:site_name" content="Time-to-Geek"><meta itemprop=name content="Build serverless system with Pulumi and AWS (Part 1)"><meta itemprop=description content="Introduction In my journey in the cloud and in the preparation of cloud certifications, I have been inspired by the AWS workshops carried out and generously made available to everyone by the AWS team.
This workshop which deals with the implementation of a serverless system is a must for all aspiring cloud engineers. It covers both the event-driven approach and the synchronous web-server mechanism.
In this post, we are working to resume the basic concept but bringing a DevOps concept with a pipeline to automate our deployments and also adding a front-end part also deployed in an automated way in the cloud."><meta itemprop=datePublished content="2023-01-02T08:13:08-04:00"><meta itemprop=dateModified content="2023-01-21T16:43:50-05:00"><meta itemprop=wordCount content="931"><meta itemprop=keywords content="Aws,IAC,Pulumi,Cloud,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Build serverless system with Pulumi and AWS (Part 1)"><meta name=twitter:description content="Introduction In my journey in the cloud and in the preparation of cloud certifications, I have been inspired by the AWS workshops carried out and generously made available to everyone by the AWS team.
This workshop which deals with the implementation of a serverless system is a must for all aspiring cloud engineers. It covers both the event-driven approach and the synchronous web-server mechanism.
In this post, we are working to resume the basic concept but bringing a DevOps concept with a pipeline to automate our deployments and also adding a front-end part also deployed in an automated way in the cloud."></head><body class="ma0 avenir bg-near-white production"><header class="cover bg-top" style=background-image:url(https://yvesdenis.github.io/images/pulumi-aws.jpeg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Time-to-Geek</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/post/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/contact/ title="Contact page">Contact</a></li></ul><div class=ananke-socials><a href=https://github.com/yvesDenis target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHubâ€”â€”Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><div class="f2 f1-l fw2 white-90 mb0 lh-title">Build serverless system with Pulumi and AWS (Part 1)</div></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">ARTICLES</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Build serverless system with Pulumi and AWS (Part 1)</h1><p class=tracked>By <strong>Yves Denis Deffo</strong></p><time class="f6 mv4 dib tracked" datetime=2023-01-02T08:13:08-04:00>January 2, 2023</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id=introduction>Introduction</h2><p>In my journey in the cloud and in the preparation of cloud certifications, I have been inspired by the AWS workshops carried out and generously made available to everyone by the AWS team.</p><p><a href=https://catalog.us-east-1.prod.workshops.aws/workshops/b34eab03-4ebe-46c1-bc63-cd2d975d8ad4/en-US>This workshop</a> which deals with the implementation of a serverless system is a must for all aspiring cloud engineers. It covers both the event-driven approach and the synchronous web-server mechanism.</p><p>In this post, we are working to resume the basic concept but bringing a DevOps concept with a pipeline to automate our deployments and also adding a front-end part also deployed in an automated way in the cloud. Let&rsquo;s have some fun! ðŸ˜‰</p><p><img src=/images/decision-regret.gif alt="I regret this decision!"></p><h3 id=functional-requirements>Functional requirements</h3><ol><li>The application should expose an endpoint to retrieve all orders items present in the database.</li><li>The application should expose an endpoint to update a particular order item present in the database.</li><li>The application should expose an endpoint to delete a particular order item present in the database.</li></ol><h2 id=architecture-diagram>Architecture diagram</h2><p><img src=/images/serverless-system/serverless-system-arch.svg alt="Serveless system sync architecture"></p><p>Our application named <strong>ORDER-API</strong> is responsible for:</p><ol><li>Creating synchronous REST API with all CRUD operations by using <strong>API Gateway</strong>, <strong>Lambda</strong> and <strong>DynamoDB</strong>. <strong>(Part 1)</strong></li><li>Exposing POST method to asynchronous method with <strong>SQS</strong> and Lambda Poller and adding <strong>Step functions</strong> to orchestrate POST operations with additional Lambda functions. <a href=https://yvesdenis.github.io/post/build-serverless-system-part-2-post/><strong>(Part 2)</strong></a></li><li>Adding authentication mechanism to your API Gateway(with <strong>AWS Incognito</strong>), then it will only allow authenticated users to access API by using OAuth2 scopes. <a href=https://yvesdenis.github.io/post/build-serverless-system-part-3-post/><strong>(Part 3)</strong></a></li></ol><h2 id=cicd-pipeline>CI/CD Pipeline</h2><p><img src=/images/serverless-system/iac-pipeline.svg alt="IAC serverless infra pipeline"></p><p>For this project, we will distinguish two types of infra as code: The first will be carried out by Github actions and it will be responsible for creating cloud resources such as <strong>Codepipeline</strong>, <strong>Codebuild</strong>, <strong>ECR</strong>, <strong>Cloudformation</strong> and the second one will rely on Codepipeline(We&rsquo;ll dive in later).
For the provisioning phase, Github actions will entrust the task to <strong>Pulumi</strong> for the generation of cloud resources.</p><blockquote><p>Pulumi ??? ðŸ˜®</p></blockquote><h3 id=pulumi>Pulumi</h3><p><a href=https://www.pulumi.com>Pulumi</a> is an universal Infrastructure code as <a href=https://www.terraform.io>Terraform</a>. In my career so far, I&rsquo;ve always used Terraform as an Iac tool because it&rsquo;s super popular and doesn&rsquo;t require knowledge of any particular programming language. But Pulumi is more aimed at an audience of developers because it allows you to do DevOps using the language you like while of course keeping the same engineering practices that Terraform offers you.</p><p>Thanks to Pulumi, we will deploy Codepipeline as well as the other components necessary to deploy our application resources:</p><ol><li>AWS ECR will host lambda docker images.</li><li>AWS Codebuild will build , tag our docker images , then prepare the output template for Cloudformation.</li><li>AWS Cloudformation will create our resources.</li></ol><p>Here&rsquo;s the pipeline triggered by any push to the serverless-system branch:</p><script type=application/javascript src=https://gist.github.com/yvesDenis/950c52c537d66d02699d43f8d4ce4960.js></script><p>In order to use the remote pulumi service , you need to create an account into <a href=https://app.pulumi.com/>https://app.pulumi.com/</a>, setup a project and create a token for Github. <a href=https://www.pulumi.com/docs/get-started/>https://www.pulumi.com/docs/get-started/</a>.</p><p>All the pulumi configuration is here , i chose Golang to write the source code: <a href=https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/iac-pulumi>https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/iac-pulumi</a></p><h2 id=api-gateway---lambda-sync>API Gateway - Lambda Sync</h2><p><img src=/images/serverless-system/apigateway-lambda-sync.svg alt="ApiGateway lambda integration"></p><pre tabindex=0><code>/orders/: Users can call this resource:
 - GET: Show order details - API Gateway -&gt; Lambda -&gt; DynamoDB
 - PUT: Create new order - API Gateway -&gt; Lambda -&gt; DynamoDB

 /orders/{userId}/order/{id}: Users can call this resource to delete a particular order
 - DELETE: Delete an order - API Gateway -&gt; Lambda -&gt; DynamoDB
</code></pre><p>The three resources business logic will be implemented inside lambdas with Golang runtime. For Lambda packaging , i chose to dockerize the source code and host the image inside a private repository in AWS ECR.</p><ol><li><p>GetOrders service : <a href=https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/lambda/get_orders>https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/lambda/get_orders</a></p></li><li><p>CreateOrder service : <a href=https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/lambda/create_orders>https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/lambda/create_orders</a></p></li><li><p>DeleteOrder service : <a href=https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/lambda/delete_orders>https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/lambda/delete_orders</a></p></li></ol><h3 id=deployment>Deployment</h3><p>To deploy all that stuff, we just need to push our changes in the serverless-system branch and Codepipeline will take care of the rest by triggering a pipeline execution. The pipeline has 3 stages:</p><ul><li>Source stage: Codepipeline loads all your source code inside a temporary directory.</li><li>Build stage: Codepipeline triggers Codebuild for eventual application building or testing. Codebuild looks for the file buildspec.yml:</li></ul><script type=application/javascript src=https://gist.github.com/yvesDenis/583b46a80ca1a9ef1414137d5c6cfdcf.js></script><p>Codebuild will log into AWS ECR , retrieves the revision commit hash for tagging docker images. In this project , we use <a href=https://docs.aws.amazon.com/serverless-application-model/index.html>SAM</a> , which is open-source framework that enables you to build serverless applications on AWS.</p><p>The <a href=https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-cli-command-reference-sam-build.html>sam build</a> validates our <a href=https://github.com/yvesDenis/website-projects-articles/blob/serverless-system/serverless-system/template.yaml>configuration template</a>, build docker images and creates an hidden folder .aws-sam/</p><p>The <a href=https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-cli-command-reference-sam-package.html>sam package</a>, in the other end , will upload lambda docker images and load all the artifacts inside a bucket S3 that it&rsquo;ll automatically create when passed &ndash;resolve-s3. A file packaged-template.yaml , will be generated by the end of the process and it&rsquo;ll contain all necessary image uri references for lambdas startup and any s3 references.</p><ul><li>Deploy stage: This stage relies on cloudformation for resources deployment. Cloudformation will look for the output file created in the previous stage and will carry out the resources creation(ApiGateway,Lambda, DynamoDB, roles, policies)</li></ul><p><img src=/images/serverless-system/codepipeline-screenshot.png alt=Codepipeline></p><h3 id=integration-testing>Integration Testing</h3><p>Let&rsquo;s try to test it out by making a request via API gateway:</p><pre tabindex=0><code># Create an order
curl --location --request PUT &#39;https://{apigateawayID}.execute-api.ca-central-1.amazonaws.com/Dev/orders&#39; \
--header &#39;Content-Type: application/json&#39; \
--data-raw &#39;{
    &#34;user_id&#34;: &#34;Burger_2&#34;,
    &#34;quantity&#34;: &#34;3&#34;,
    &#34;restaurant_id&#34;: &#34;Restaurant 3&#34;
}&#39;

# Get Orders
Request:
    curl --location --request GET &#39;https://{apigateawayID}.execute-api.ca-central-1.amazonaws.com/Dev/orders&#39;
Response:
    [{&#34;user_id&#34;:&#34;Burger_2&#34;,&#34;restaurant_id&#34;:&#34;Restaurant 3&#34;,&#34;quantity&#34;:&#34;3&#34;,&#34;id&#34;:&#34;81&#34;,&#34;created_at&#34;:&#34;2023-01-02T22:06:33.637839308Z&#34;,&#34;order_status&#34;:&#34;PENDING&#34;}]


# Delete an order
curl --location --request DELETE &#39;https://{apigateawayID}.execute-api.ca-central-1.amazonaws.com/Dev/order/Burger_2/id/81&#39;
</code></pre><h3 id=local-testing>Local Testing</h3><p>For local testing , there&rsquo;s a makefile inside each lambda folder:</p><script type=application/javascript src=https://gist.github.com/yvesDenis/cc0a4b319d803286dbb2e4c4518cba18.js></script><h2 id=conclusion>Conclusion</h2><p>For this first part , we set up two CI/CD pipelines , one triggered by Github action for deploying codepipeline with its related components and the other is handled by Codepipeline to update, create or remove our resources involved in the Api gateway integration with lambda. For the second part , we&rsquo;ll break down the event-driven approach with our same APigateway but integrated with SQS and Step functions. To be continued&mldr; ðŸ˜‰</p><ul class=pa0><li class="list di"><a href=/tags/aws/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Aws</a></li><li class="list di"><a href=/tags/iac/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">IAC</a></li><li class="list di"><a href=/tags/pulumi/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Pulumi</a></li><li class="list di"><a href=/tags/cloud/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Cloud</a></li></ul><div class=addthis_inline_share_toolbox></div><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script"),n="https-yvesdenis-github-io";t.src="https://"+n+".disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">What's in this post</p><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#functional-requirements>Functional requirements</a></li></ul></li><li><a href=#architecture-diagram>Architecture diagram</a></li><li><a href=#cicd-pipeline>CI/CD Pipeline</a><ul><li><a href=#pulumi>Pulumi</a></li></ul></li><li><a href=#api-gateway---lambda-sync>API Gateway - Lambda Sync</a><ul><li><a href=#deployment>Deployment</a></li><li><a href=#integration-testing>Integration Testing</a></li><li><a href=#local-testing>Local Testing</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/post/ecs-ecr-codebuild-part-2-post/>Build, deploy and run an application with ECR, ECS and Codebuild (Part 2)</a></li><li class=mb2><a href=/post/ecs-ecr-codebuild-part-1-post/>Build, deploy and run an application with ECR, ECS and Codebuild (Part 1)</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://yvesdenis.github.io/>&copy; Time-to-Geek 2023</a><div><div class=ananke-socials><a href=https://github.com/yvesDenis target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHubâ€”â€”Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer><script id=dsq-count-scr src=//https-yvesdenis-github-io.disqus.com/count.js async></script>
<script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-6382ff1e2fa5e2f7"></script></body></html>