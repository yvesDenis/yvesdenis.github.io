<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Build serverless system with Pulumi and AWS (Part 2) | Time-to-Geek</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Introduction In our previous article, we focused on the lambda-Sync part of our serverless system which corresponds to the synchronous part of our application.
We had already set up our entire continuous integration pipeline consisting of Github for the VCS, Codebuild to build our docker images and finally Cloudformation to deploy our resources in the AWS environment.
For this second part, there is no need to reinvent the wheel. We will use the instruments already in place and implement our asynchronous circuit."><meta name=generator content="Hugo 0.110.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.98b8feee71ad3d56ea881041d877c631e7268369636aa10acbcb1c7f3bd3ea41.css><meta property="og:title" content="Build serverless system with Pulumi and AWS (Part 2)"><meta property="og:description" content="Introduction In our previous article, we focused on the lambda-Sync part of our serverless system which corresponds to the synchronous part of our application.
We had already set up our entire continuous integration pipeline consisting of Github for the VCS, Codebuild to build our docker images and finally Cloudformation to deploy our resources in the AWS environment.
For this second part, there is no need to reinvent the wheel. We will use the instruments already in place and implement our asynchronous circuit."><meta property="og:type" content="article"><meta property="og:url" content="https://yvesdenis.github.io/post/build-serverless-system-part-2-post/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-15T12:16:46-05:00"><meta property="article:modified_time" content="2023-01-21T16:43:50-05:00"><meta property="og:site_name" content="Time-to-Geek"><meta itemprop=name content="Build serverless system with Pulumi and AWS (Part 2)"><meta itemprop=description content="Introduction In our previous article, we focused on the lambda-Sync part of our serverless system which corresponds to the synchronous part of our application.
We had already set up our entire continuous integration pipeline consisting of Github for the VCS, Codebuild to build our docker images and finally Cloudformation to deploy our resources in the AWS environment.
For this second part, there is no need to reinvent the wheel. We will use the instruments already in place and implement our asynchronous circuit."><meta itemprop=datePublished content="2023-01-15T12:16:46-05:00"><meta itemprop=dateModified content="2023-01-21T16:43:50-05:00"><meta itemprop=wordCount content="885"><meta itemprop=keywords content="Aws,IAC,Pulumi,Cloud,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Build serverless system with Pulumi and AWS (Part 2)"><meta name=twitter:description content="Introduction In our previous article, we focused on the lambda-Sync part of our serverless system which corresponds to the synchronous part of our application.
We had already set up our entire continuous integration pipeline consisting of Github for the VCS, Codebuild to build our docker images and finally Cloudformation to deploy our resources in the AWS environment.
For this second part, there is no need to reinvent the wheel. We will use the instruments already in place and implement our asynchronous circuit."></head><body class="ma0 avenir bg-near-white production"><header class="cover bg-top" style=background-image:url(https://yvesdenis.github.io/images/pulumi-aws.jpeg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Time-to-Geek</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/post/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/contact/ title="Contact page">Contact</a></li></ul><div class=ananke-socials><a href=https://github.com/yvesDenis target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><div class="f2 f1-l fw2 white-90 mb0 lh-title">Build serverless system with Pulumi and AWS (Part 2)</div></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">ARTICLES</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Build serverless system with Pulumi and AWS (Part 2)</h1><p class=tracked>By <strong>Yves Denis Deffo</strong></p><time class="f6 mv4 dib tracked" datetime=2023-01-15T12:16:46-05:00>January 15, 2023</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id=introduction>Introduction</h2><p>In our <a href=https://yvesdenis.github.io/post/build-serverless-system-part-1-post/>previous article</a>, we focused on the lambda-Sync part of our serverless system which corresponds to the synchronous part of our application.</p><p>We had already set up our entire continuous integration pipeline consisting of <strong>Github</strong> for the VCS, <strong>Codebuild</strong> to build our docker images and finally <strong>Cloudformation</strong> to deploy our resources in the AWS environment.</p><p>For this second part, there is no need to reinvent the wheel. We will use the instruments already in place and implement our asynchronous circuit.</p><p><a href=https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system>The full source code of this project</a></p><h3 id=functional-requirements>Functional requirements</h3><ol><li>The application should expose an endpoint to create an order item.</li><li>The Create operation should be asynchronous. The response status code is <strong>204</strong> for a successful operation.</li><li>The Create operation should insert an order record in the database.</li><li>Once an order is registered in the database, it must go through the payment process and eventually be sent to a restaurant. If the payment process is successful, the order can be sent to a restaurant, in this case the end user should receive an email with the status of the transaction.</li></ol><h2 id=architecture-diagram>Architecture diagram</h2><p><img src=/images/serverless-system/serverless-system-async-arch.svg alt="Serveless system Async architecture"></p><p>For this part , we deployed new aws resources through Cloudformation : <strong>SQS</strong> , <strong>SNS</strong> , <strong>Stepfunctions</strong></p><h3 id=sqs>SQS</h3><p><a href="https://aws.amazon.com/sqs/?nc1=h_ls">AWS SQS</a> is a message queue service used by distributed applications to exchange messages through a polling model, and can be used to decouple sending and receiving components. In case of high rate of create operations, it helps us to buffer orders in the queue so that our lambda services are not overwhelmed. it&rsquo;s a serverless system so it&rsquo;s fully managed and automatically scales.</p><p>In case of failure while procssing a message , we set up a Dead letter queue which is another queue which recives only problematic messages.</p><pre tabindex=0><code>##########################################################################
#           SQS QUEUE AND DLQ                                            # 
##########################################################################

  OrderQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: &#34;OrderQueue&#34;
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt [OrderDLQueue,Arn]
        maxReceiveCount: 3

  OrderDLQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: &#34;OrderDeathLetterQueue&#34;
</code></pre><p>To integrate this queue with ApiGateway we add a new resource api as is :</p><pre tabindex=0><code>
post:
      consumes:
      - &#34;application/json&#34;
      produces:
      - &#34;application/json&#34;
      responses:
        &#34;201&#34;:
          description: &#34;201 response&#34;
      x-amazon-apigateway-integration:
        type: &#34;aws&#34;
        credentials: 
          Fn::GetAtt: [ ApiGwExecutionRole, Arn ]
        httpMethod: &#34;POST&#34;
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:sqs:path/${AWS::AccountId}/${OrderQueue.QueueName}
        responses:
          default:
            statusCode: &#34;201&#34;
        requestParameters:
          integration.request.header.Content-Type: &#34;&#39;application/x-www-form-urlencoded&#39;&#34;
        requestTemplates:
          application/json: &#34;Action=SendMessage&amp;MessageBody={\&#34;data\&#34;:$input.json(&#39;$&#39;)}&#34;
        passthroughBehavior: &#34;when_no_match&#34;
</code></pre><p>For the Post request, our apigateway will send the response body to <strong>OrderQueue</strong>. At line 79 the content type must be
<strong>application/x-www-form-urlencoded</strong> and at line 81 we defined the message body of the sqs event.</p><h3 id=stepfunctions>Stepfunctions</h3><p><a href="https://aws.amazon.com/step-functions/?nc1=h_ls">AWS Step Functions</a> is a serverless orchestration service that lets you integrate with AWS Lambda functions and other AWS services to build business-critical applications. It consists of three main components such as <a href=https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-state-machine-structure.html>State machines</a> , <a href=https://docs.aws.amazon.com/step-functions/latest/dg/concepts-states.html>States</a> and <a href=https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-task-state.html>Task states</a>.</p><p>In our case it helps us orchestrate 3 different lambdas by managing the order management workflow. The state machine definition used for this project is <a href=https://github.com/yvesDenis/website-projects-articles/blob/serverless-system/serverless-system/stepfunctions/order.asl.json>here</a></p><p>We add this config in our Cloudformation template :</p><pre tabindex=0><code>
##########################################################################
#           STEPFUNCTIONS                                                # 
##########################################################################

  OrderStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties: 
      DefinitionUri: ./stepfunctions/order.asl.json
      DefinitionSubstitutions:
        ManageOrderStateArn: !GetAtt ManageOrderStateFunction.Arn
        ProcessPaymentArn: !GetAtt ProcessPaymentFunction.Arn
        SendOrderArn: !GetAtt SendOrderFunction.Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref ManageOrderStateFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ProcessPaymentFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref SendOrderFunction
        - Version: &#34;2012-10-17&#34;
          Statement:
            - Effect: Allow
              Action:
                - cloudwatch:*
                - logs:*
              Resource:
                - &#34;*&#34; 
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup: 
              LogGroupArn: !GetAtt OrderStateMachineLog.Arn
        IncludeExecutionData: true
        Level: &#39;ALL&#39;

  OrderStateMachineLog:
    Type: AWS::Logs::LogGroup 
    Properties:
      LogGroupName: !Join [&#34;/&#34;, [&#34;stepfunctions&#34;,OrderStateMachine]]
</code></pre><p>&mldr;which results to this graph view in the AWS console:</p><p><img src=/images/serverless-system/step-functions-order-api-asl.png alt="Stepfunctions asl"></p><p>As seen in the figure above , the workflow starts with the task <strong>Save Order</strong> implemented by the <a href=https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/lambda/order-management/manage_order_states>manage state service</a>, it will save the order in the dynamodb table.</p><p>The next step is the process payment executed by <a href=https://github.com/yvesDenis/website-projects-articles/tree/serverless-system/serverless-system/lambda/order-management/process_payments>payment process service</a> which will randomly decides whether the payment status is ok or not.</p><p>After the payment process, the workflow will pause for 30s and afterwards makes a choice based on th payment status:</p><ul><li>If the payment is ok , the order will be sent to the restaurant.</li><li>If the payment is not ok, the state machine will end the workflow.
In both cases the order status is updated in the database.</li></ul><h3 id=sns>SNS</h3><p><a href="https://aws.amazon.com/sns/?nc1=h_ls">AWS SNS</a> is a managed messaging service for communication, allowing messaging between decoupled microservices applications or directly to users with SMS or Email. It&rsquo;s used in this project to send notification about the order status to the end user who creates the order.</p><pre tabindex=0><code>
##########################################################################
#                      SNS TOPIC                                         # 
##########################################################################

  OrderSnsTopic:
    Type: AWS::SNS::Topic
    Properties: 
      Subscription: 
        - Endpoint: !Ref UserEmail
          Protocol: &#34;email&#34;
      TopicName: &#34;Order-sns-topic&#34;
</code></pre><p>PS: Once Cloudformation will deploy this resource , the owner of the email address will receive an subscription confirmation email from AWS.</p><h2 id=integration-test>Integration test</h2><p>Let&rsquo;s try to create an order by making a post request to the apigateway(from command line):</p><pre tabindex=0><code>-- Request:

curl --location --request POST &#39;https://xxxxxx.execute-api.ca-central-1.amazonaws.com/Dev/orders/&#39; \
--header &#39;Content-Type: application/json&#39; \
--data-raw &#39;{
    &#34;user_id&#34;: &#34;Burger_20&#34;,
    &#34;quantity&#34;: &#34;3&#34;,
    &#34;restaurant_id&#34;: &#34;Restaurant 4&#34;
}&#39;


-- Response:

{&#34;SendMessageResponse&#34;:{&#34;ResponseMetadata&#34;:{&#34;RequestId&#34;:&#34;80d9961e-2514-5879-97b4-ca207d6766ef&#34;},&#34;SendMessageResult&#34;:{&#34;MD5OfMessageAttributes&#34;:null,&#34;MD5OfMessageBody&#34;:&#34;e172a0b1b0c410a6d12b96ef434aa4c0&#34;,&#34;MD5OfMessageSystemAttributes&#34;:null,&#34;MessageId&#34;:&#34;603cdde2-74aa-4233-aac0-ec02a3160103&#34;,&#34;SequenceNumber&#34;:null}}}
</code></pre><p>Ok , let&rsquo;s take a look at the Dynamodb table:</p><p><img src=/images/serverless-system/dynamodb-table-order.png alt="Dynamodb table order"></p><p>&mldr;And we just receive an email notification from sns:</p><p><img src=/images/serverless-system/sns-email-notification.png alt="Sns email notification"></p><p>Et Voila! 😃</p><h2 id=conclusion>Conclusion</h2><p>For the second part , we implemented the async process of order management with sqs, sns and stepfunctions. Those are resources heavily used in real world scenarios so it&rsquo;s important to know are they work independently and together. For the next step , we&rsquo;ll need to secure our apigateway endpoints with an AWS authentication resource called <strong>Amazon Cognito</strong> so stay tuned&mldr; 😉</p><ul class=pa0><li class="list di"><a href=/tags/aws/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Aws</a></li><li class="list di"><a href=/tags/iac/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">IAC</a></li><li class="list di"><a href=/tags/pulumi/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Pulumi</a></li><li class="list di"><a href=/tags/cloud/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Cloud</a></li></ul><div class=addthis_inline_share_toolbox></div><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script"),n="https-yvesdenis-github-io";t.src="https://"+n+".disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">What's in this post</p><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#functional-requirements>Functional requirements</a></li></ul></li><li><a href=#architecture-diagram>Architecture diagram</a><ul><li><a href=#sqs>SQS</a></li><li><a href=#stepfunctions>Stepfunctions</a></li><li><a href=#sns>SNS</a></li></ul></li><li><a href=#integration-test>Integration test</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/post/build-serverless-system-part-1-post/>Build serverless system with Pulumi and AWS (Part 1)</a></li><li class=mb2><a href=/post/ecs-ecr-codebuild-part-2-post/>Build, deploy and run an application with ECR, ECS and Codebuild (Part 2)</a></li><li class=mb2><a href=/post/ecs-ecr-codebuild-part-1-post/>Build, deploy and run an application with ECR, ECS and Codebuild (Part 1)</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://yvesdenis.github.io/>&copy; Time-to-Geek 2023</a><div><div class=ananke-socials><a href=https://github.com/yvesDenis target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer><script id=dsq-count-scr src=//https-yvesdenis-github-io.disqus.com/count.js async></script>
<script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-6382ff1e2fa5e2f7"></script></body></html>